#!/usr/bin/env ansible-playbook
---
- hosts: localhost
  vars:
    ansible_ask_become_pass: true
    # configs:
    # - alacritty
    # - lf
    # - mpv
    # - pass-git-helper
    # - flameshot
    # - zathura

  tasks:
  - name: "Install Docker tools"
    community.general.pacman:
      name:
      - docker
      - podman
      - skopeo
      - helm
      - k9s
      - kubectl
      - kubectx
      - minikube
      state: latest
    become: yes

  - name: "Add current user to docker group"
    ansible.builtin.user:
      name: "{{ ansible_user_id }}"
      groups: docker
      append: yes
    become: yes

  - name: "Copy Docker Configuration file"
    ansible.builtin.copy:
      src: "{{ playbook_dir }}/config/docker/daemon.json"
      dest: /etc/docker/daemon.json
      mode: "0644"
    become: yes

  - name: "Enable nested virtualization"
    community.general.modprobe:
      name: kvm_intel
      params: "nested=1"
      state: present
    become: yes

  - name: "Install Libvirt and Virtualization tools"
    community.general.pacman:
      name:
      - libvirt
      - qemu-base
      - dmidecode
      - dnsmasq
      state: latest
    become: yes

  - name: "Install Additional tools for libvirt"
    community.general.pacman:
      name:
      - virt-install
      - virt-viewer
      - libguestfs
      state: latest
    become: yes

  - name: "Add current user to docker group"
    ansible.builtin.user:
      name: "{{ ansible_user_id }}"
      groups: libvirt
      append: yes
    become: yes

  - name: "Set the UNIX domain socket group ownership to libvirt"
    ansible.builtin.lineinfile:
      path: /etc/libvirt/libvirtd.conf
      regexp: '^#unix_sock_group'
      line: 'unix_sock_group = "libvirt"'
      state: present
    become: yes

  - name: "Set the UNIX domain socket group ownership to libvirt"
    ansible.builtin.lineinfile:
      path: /etc/libvirt/libvirtd.conf
      regexp: '^#unix_sock_rw_perms'
      line: 'unix_sock_rw_perms = "0770"'
      state: present
    become: yes

  - name: "Install Cockpit"
    community.general.pacman:
      name:
      - cockpit
      - cockpit-machines
      - cockpit-podman
      - cockpit-pcp
      state: latest
    become: yes

  - name: "Install Cockpit ZFS plugin"
    kewlfft.aur.aur:
      name: cockpit-zfs-manager
      state: latest
    become: yes
    become_user: aur_builder

  - name: "Install Cockpit File Sharing plugin"
    kewlfft.aur.aur:
      name: cockpit-file-sharing
      state: latest
    become: yes
    become_user: aur_builder

  - name: "Enable Libvirt"
    ansible.builtin.systemd:
      name: libvirtd
      state: started
      enabled: yes
    become: yes

  - name: "Enable Docker"
    ansible.builtin.systemd:
      name: "{{ item }}"
      state: started
      enabled: yes
    become: yes
    loop:
    - docker.socket
    - podman.socket
    - libvirtd.socket
    - cockpit.socket
...
